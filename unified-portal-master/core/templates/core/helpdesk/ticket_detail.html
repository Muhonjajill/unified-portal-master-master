{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/ticket_detail.css' %}">
{% endblock %}

{% block title %}Ticket #{{ ticket.id }}{% endblock %}

{% block content %}
<div class="ticket-detail-container">
  <div class="ticket-card">
    <h2>🎟️ Ticket 0{{ ticket.id }} - {{ ticket.title }}</h2>

    <div class="ticket-info">
      <div><strong>Status:</strong> <span class="badge badge-{{ ticket.status }}">{{ ticket.get_status_display }}</span></div>
      <div><strong>Priority:</strong> <span class="badge badge-{{ ticket.priority }}">{{ ticket.get_priority_display }}</span></div>
      <div><strong>BRTS Unit:</strong> {{ ticket.brts_unit }}</div>
      <div><strong>Terminal:</strong> {{ ticket.terminal }}</div>
      <div><strong>Comments:</strong><br><p class="comment-summary">{{ ticket.comment_summary }}</p></div>
      <div><strong>Problem Category:</strong> {{ ticket.problem_category }}</div>
      <div><strong>Description:</strong><br><p class="description">{{ ticket.description }}</p></div>
      <div><strong>Created By:</strong> {{ ticket.created_by }}</div>
      <div><strong>Created At:</strong> {{ ticket.created_at|date:"Y-m-d H:i" }}</div>
    </div>

    <div class="mt-4">
      {% if is_admin or is_editor %}
        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editTicketModal">✏️ Edit Ticket</button>

        <form method="post" action="{% url 'resolve_ticket' ticket.id %}" class="d-inline-block ms-2">
          {% csrf_token %}
          <button type="submit" class="btn btn-success">✅ Resolve Ticket</button>
        </form>
      {% elif can_resolve %}
        <form method="post" action="{% url 'resolve_ticket' ticket.id %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-success">✅ Resolve Ticket</button>
        </form>
      {% else %}
        <span class="badge badge-success">✔️ Resolved</span>
      {% endif %}
    </div>

    <a href="{% url 'ticketing_dashboard' %}" class="btn btn-back mt-3">← Back to Tickets</a>

    <div class="card mt-5">
      <div class="card-header bg-light">
        <h4 class="card-title">📝 Comments</h4>
      </div>
      <div class="card-body">
        {% if comments %}
          {% for comment in comments %}
            <div class="comment mb-3 p-2 border rounded">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <strong>{{ comment.created_by }}</strong>
                  <small class="text-muted">({{ comment.created_at|date:"Y-m-d H:i" }})</small>
                </div>
                {% if comment.created_by == request.user or user.is_superuser %}
                  <div class="comment-actions">
                    <a href="{% url 'edit_comment' comment.id %}" class="btn btn-sm btn-outline-primary">Edit</a>
                    <form method="post" action="{% url 'delete_comment' comment.id %}" style="display:inline;">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                    </form>
                  </div>
                {% endif %}
              </div>
              <p class="mt-2 mb-0">{{ comment.content }}</p>
            </div>
          {% endfor %}
        {% else %}
          <p class="text-muted">No comments yet.</p>
        {% endif %}

        <form method="post" class="mt-4">
          {% csrf_token %}
          {{ comment_form.as_p }}
          <button type="submit" name="add_comment" class="btn btn-primary">💬 Add Comment</button>
        </form>
      </div>
    </div>
  </div>
</div>

{% if is_admin or is_editor %}
<div class="modal fade" id="editTicketModal" tabindex="-1" aria-labelledby="editTicketModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form method="post">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="editTicketModalLabel">Edit Ticket #{{ ticket.id }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          {{ form.as_p }}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">💾 Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}
