{% extends "files_base.html" %}
{% load static %}

{% block title %}File Management{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/file_list.css' %}">
{% endblock %}

{% block content %}
<div class="container">
  <h2 class="page-title">üìÇ File Management</h2>

  <!-- Category Buttons -->
  <div class="category-nav">
    <a href="{% url 'upload_file' %}" class="upload-button">‚ûï Upload New File</a>
    <a href="{% url 'file_list' %}" class="{% if not active_category %}active{% endif %}">All</a>
    {% for category in categories %}
      <a href="{% url 'file_list_by_category' category.name %}" class="{% if category.name == active_category %}active{% endif %}">{{ category.name }}</a>
    {% endfor %}
  </div>

  <h3 class="section-subtitle">{% if active_category %}{{ active_category }}{% else %}All Files{% endif %}</h3>

  <ul class="file-list">
    {% for file in files %}
      <li class="file-item">
        <div class="file-preview">
          {% if ".pdf" in file.file.name|lower %}
            <img src="{% static 'icons/pdf.png' %}" alt="PDF Icon" />
          {% elif ".docx" in file.file.name|lower %}
            <img src="{% static 'icons/docx.png' %}" alt="DOCX Icon" />
          {% elif ".jpg" in file.file.name|lower or ".png" in file.file.name|lower %}
            <img src="{{ file.file.url }}" alt="Image Preview" class="image-thumb" />
          {% else %}
            <img src="{% static 'icons/file-icon.png' %}" alt="Generic File Icon" />
          {% endif %}
        </div>

        <div class="file-info">
          <h4 class="file-title">{{ file.title }}</h4>
          <p>{{ file.description }}</p>
          <p><strong>Size:</strong> {{ file.file.size|filesizeformat }}</p>
          <p><strong>Access:</strong> 
            <span class="tag {{ file.access_level }}">{{ file.access_level|title }}</span>
          </p>
          <p><strong>Uploaded by:</strong> {{ file.uploaded_by }}</p>

          <div class="file-actions">
            {% if perms.core.view_file or perms.core.change_file %}
            <a href="{{ file.file.url }}" download class="btn download-link">‚¨á Download</a>
            {% endif %}

            {% if perms.core.view_file %}
            <a href="{% url 'preview_file' file.id %}" target="_blank" class="btn preview-link">üëÅ Preview</a>
            {% endif %}
            
            {% if perms.core.delete_file %}
            <form method="POST" action="{% url 'delete_file' file.id %}" class="delete-form" onsubmit="return confirm('Are you sure you want to delete this file?');">
              {% csrf_token %}
              <button type="submit" class="delete-link">üóë Delete</button>
            </form>
            {% endif %}
          </div>
        </div>
      </li>
    {% empty %}
      <li class="file-item empty">No files found in this category.</li>
    {% endfor %}
  </ul>
</div>

<div class="pagination">
  <span class="step-links">
    {% if files.has_previous %}
      <a href="?page=1{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}">&laquo; first</a>
      <a href="?page={{ files.previous_page_number }}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}">previous</a>
    {% endif %}

    <span class="current">
      Page {{ files.number }} of {{ files.paginator.num_pages }}.
    </span>

    {% if files.has_next %}
      <a href="?page={{ files.next_page_number }}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}">next</a>
      <a href="?page={{ files.paginator.num_pages }}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}">last &raquo;</a>
    {% endif %}
  </span>
</div>
{% endblock %}
